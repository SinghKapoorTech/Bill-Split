---
title: Bills Collection Schema
date: 2026-02-21
tags: [database, schema, firestore, bills]
---

# `bills` Collection

The `bills` collection is the core transactional entity of the application. It represents a single receipt being split among multiple people. Documents are heavily updated in real-time during collaborative sessions.

## Document ID
Auto-generated by Firestore.

## Schema (`Bill`)

| Field                  | Type               | Description                                                                                                                                                                                                           |
| ---------------------- | ------------------ | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `id`                   | String             | The document ID.                                                                                                                                                                                                      |
| `title`                | String (Optional)  | Custom name for the bill.                                                                                                                                                                                             |
| `billType`             | String             | Enum: `'private'` \| `'event'`.                                                                                                                                                                                       |
| `status`               | String             | Enum: `'active'` \| `'archived'`.                                                                                                                                                                                     |
| `ownerId`              | String             | Ref to **[Users](users.md)** (Creator/Payer).                                                                                                                                                                         |
| `eventId`              | String (Optional)  | Ref to **[Events](events.md)** (if `billType === 'event'`).                                                                                                                                                           |
| `squadId`              | String (Optional)  | Ref to **[Squads](squads.md)** (if imported from a squad).                                                                                                                                                            |
| `isSimpleTransaction`  | Boolean (Optional) | Flag indicating if this bill is a simplified "Quick Expense" transaction.                                                                                                                                             |
| `paidById`             | String (Optional)  | Ref to **[Users](users.md)** or bill-local person ID. Overrides `ownerId` as the creditor for balances.                                                                                                               |
| `processedBalances`    | Object (Optional)  | Map of `{ [Firebase UID]: amountOwedToCreditor }`. Tracking footprint of what was explicitly added to the global `friend_balances` ledger. Used by the Idempotent Delta engine to perfectly reverse math on re-edits. |
| `settledPersonIds`     | Array of String    | Optional list of users who have already settled their portion of this specific bill and should be calculated as owing $0.                                                                                             |
| `createdAt`            | Timestamp          | Creation time.                                                                                                                                                                                                        |
| `updatedAt`            | Timestamp          | Last modification time.                                                                                                                                                                                               |
| `lastActivity`         | Timestamp          | Tracks latest interaction.                                                                                                                                                                                            |

### Financial Data (`billData`)

Stores the actual money values involved.

| Sub-Field        | Type              | Description                            |
| ---------------- | ----------------- | -------------------------------------- |
| `restaurantName` | String (Optional) | Parsed restaurant name from receipt.   |
| `subtotal`       | Number            | Sum of all item prices before tax/tip. |
| `tax`            | Number            | Tax amount in USD.                     |
| `tip`            | Number            | Tip amount in USD.                     |
| `total`          | Number            | Grand total in USD.                    |
| `items`          | Array of Object   | `{ id, name, price }` per line item.   |

### Participant Data

- **`members`**: Array of `BillMember` objects. Records who officially joined the session via share link.
  - `userId`, `name`, `email`, `joinedAt`, `isAnonymous`
- **`people`**: Array of local `Person` objects (`{ id, name, venmoId? }`). This is the working list used during session to track everyone involved — including manually-added people who may not have Firebase accounts.

> [!IMPORTANT]
> The `id` field on a `Person` in the `people` array uses one of three formats:
> - **`user-{uid}`** — The standard format for any user added via the app (logged-in user, event members, friends list). Generated by `generateUserId(uid)`. The ledger services strip the `user-` prefix to recover the raw Firebase UID for balance writes.
> - **`guest-{uuid}`** — A guest user who joined via share link without logging in.
> - **`{random-uuid}`** — A person added purely by name in the bill wizard (no Firebase account). These are skipped by the balance engine since no Firebase UID can be resolved.
>
> Only `user-{uid}` people whose raw Firebase UID matches someone in the owner's `friends` list are written to **[[friend_balances]]** when the bill is finalized.

### Assignment Data

- **`itemAssignments`**: A Map where the key is `itemId` and the value is an array of `personId`s sharing that item.  
  *Example:* `{ "item_abc": ["uid_alice", "uid_bob"] }`
- **`splitEvenly`**: Boolean. If `true`, `itemAssignments` is overridden so every `personId` is on every item.

### Creation Lifecycle (Lazy Drafts)

To prevent database bloat, new bills utilize a **Client-Side Draft (Just-In-Time) Creation** flow rather than eager creation.

1.  **`/bill/new` Memory State**: When a user clicks "New Bill", the router navigates to `/bill/new`. At this stage, **no document exists in Firestore**. The `AIScanView` and `useBillSession` hook initialize empty temporary state in local React memory.
2.  **Smart Saving (JIT Creation)**: The `useBillSession` hook monitors the draft data. It refuses to call `billService.createBill` until the user performs a meaningful action (adding an item, taking a photo, or typing a title).
3.  **Explicit Action Saves**: Implicit background saves (like step-changes, debouncing, or unmounting) have been completely removed. Writes to Firestore trigger *strictly* upon explicit user confirmation (e.g., clicking a checkmark after editing an item, or typing a new tax/tip value). This guarantees real-time sync without ghost updates.
4.  **Silent URL Swap**: Once meaningful data is explicitly saved (e.g., clicking the save button after entering an item), the document is created yielding a Firestore ID. The client silently swamps the URL to `/bill/{new_id}` without refreshing the page, seamlessly transitioning from memory to realtime syncing.

### Session & Sharing

| Field                 | Type              | Description                                  |
| --------------------- | ----------------- | -------------------------------------------- |
| `currentStep`         | Number (Optional) | Tracks wizard step for draft resumption.     |
| `receiptImageUrl`     | String (Optional) | Firebase Storage download URL.               |
| `receiptFileName`     | String (Optional) | Storage path for image deletion.             |
| `shareCode`           | String (Optional) | 6-character shortcode for session joining.   |
| `shareCodeCreatedAt`  | Timestamp (Optional) | When the share code was generated.        |
| `shareCodeExpiresAt`  | Timestamp (Optional) | When the share code expires.              |
| `shareCodeCreatedBy`  | String (Optional) | UID of user who generated the share code.    |

## Balance Lifecycle

Since the client no longer directly writes to `friend_balances` or `event_balances`, the bill's balance lifecycle is entirely managed by the backend **`ledgerProcessor` Cloud Function**. (See [[../backend/cloud_functions|Cloud Functions Architecture]] for full details).

### On Bill Creation & Modification

Whenever a bill is initially saved to Firestore or subsequently modified (e.g., adding an item, changing assignments, checking off a user as "Settled"):

1. The `ledgerProcessor` detects the `onDocumentWritten` event.
2. It validates the bill and resolves the `people` IDs against the owner's friends list to fetch the true Firebase UIDs.
3. In a single, idempotent transaction, the backend engine strictly reverses the math stored in `processedBalances` from the user's global `friend_balances`, applies the new calculated totals, and updates `processedBalances` back onto the bill.
4. If this is an event bill, the pipeline automatically triggers a rebuild of the `event_balances` cache.
5. The UI updates seamlessly via `onSnapshot` listeners hooked to the `friend_balances` ledger.

> [!NOTE]
> The simple act of saving the bill draft securely applies the math. The Review Step still exists to summarize the math and allow for Venmo integration, but there are no `ledgerService` calls in the UI.

### On Bill Deletion

When a user deletes a bill:

1. The client simply deletes the document from the `bills` collection.
2. The `ledgerProcessor` detects the document deletion `before` snapshot.
3. The server natively reverses the exact footprint recorded in `processedBalances` from the `friend_balances` ledger.
4. The event cache automatically rebuilds without the deleted bill context.

> [!NOTE]
> The Historical Ledger Sync / Self-Healing job (`syncOldBillsForUser`) has been **removed** as part of the ledger unification refactor. The completely unified Server-Side write path guarantees unshakeable consistency between both ledgers, preventing desync altogether.

## Concurrency

Updates to `itemAssignments` and `people` use Firestore's atomic `arrayUnion` / `arrayRemove` operations to prevent race conditions in collaborative sessions.

## Relationships

References **[Users](users.md)**, **[Events](events.md)**, **[Squads](squads.md)**, and **[[friend_balances]]**.
