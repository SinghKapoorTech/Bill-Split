---
title: Bills Collection Schema
date: 2026-02-21
tags: [database, schema, firestore, bills]
---

# `bills` Collection

The `bills` collection is the core transactional entity of the application. It represents a single receipt being split among multiple people. Documents are heavily updated in real-time during collaborative sessions.

## Document ID
Auto-generated by Firestore.

## Schema (`Bill`)

| Field               | Type              | Description                                                                                                                                                                                                           |
| ------------------- | ----------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `id`                | String            | The document ID.                                                                                                                                                                                                      |
| `title`             | String (Optional) | Custom name for the bill.                                                                                                                                                                                             |
| `billType`          | String            | Enum: `'private'` \| `'event'`.                                                                                                                                                                                       |
| `status`            | String            | Enum: `'active'` \| `'archived'`.                                                                                                                                                                                     |
| `ownerId`           | String            | Ref to **[Users](users.md)** (Creator/Payer).                                                                                                                                                                         |
| `eventId`           | String (Optional) | Ref to **[Events](events.md)** (if `billType === 'event'`).                                                                                                                                                           |
| `squadId`           | String (Optional) | Ref to **[Squads](squads.md)** (if imported from a squad).                                                                                                                                                            |
| `processedBalances` | Object (Optional) | Map of `{ [Firebase UID]: amountOwedToOwner }`. Tracks which friend's balances have been committed to **[[friend_balances]]** for this bill. Used to calculate deltas on re-edit and to reverse balances on deletion. |
| `createdAt`         | Timestamp         | Creation time.                                                                                                                                                                                                        |
| `updatedAt`         | Timestamp         | Last modification time.                                                                                                                                                                                               |
| `lastActivity`      | Timestamp         | Tracks latest interaction.                                                                                                                                                                                            |

### Financial Data (`billData`)

Stores the actual money values involved.

| Sub-Field        | Type              | Description                            |
| ---------------- | ----------------- | -------------------------------------- |
| `restaurantName` | String (Optional) | Parsed restaurant name from receipt.   |
| `subtotal`       | Number            | Sum of all item prices before tax/tip. |
| `tax`            | Number            | Tax amount in USD.                     |
| `tip`            | Number            | Tip amount in USD.                     |
| `total`          | Number            | Grand total in USD.                    |
| `items`          | Array of Object   | `{ id, name, price }` per line item.   |

### Participant Data

- **`members`**: Array of `BillMember` objects. Records who officially joined the session via share link.
  - `userId`, `name`, `email`, `joinedAt`, `isAnonymous`
- **`people`**: Array of local `Person` objects (`{ id, name, venmoId? }`). This is the working list used during session to track everyone involved — including manually-added people who may not have Firebase accounts.

> [!IMPORTANT]
> The `id` field on a `Person` in the `people` array is either:
> - A **Firebase UID** (if the person was added from the friends list via `resolveUser()`)
> - A **local UUID** (if the person was added manually by name in the bill wizard)
>
> This distinction matters: only people with Firebase UIDs are written to **[[friend_balances]]** when the bill is finalized.

### Assignment Data

- **`itemAssignments`**: A Map where the key is `itemId` and the value is an array of `personId`s sharing that item.  
  *Example:* `{ "item_abc": ["uid_alice", "uid_bob"] }`
- **`splitEvenly`**: Boolean. If `true`, `itemAssignments` is overridden so every `personId` is on every item.

### Session & Sharing

| Field                 | Type              | Description                                  |
| --------------------- | ----------------- | -------------------------------------------- |
| `currentStep`         | Number (Optional) | Tracks wizard step for draft resumption.     |
| `receiptImageUrl`     | String (Optional) | Firebase Storage download URL.               |
| `receiptFileName`     | String (Optional) | Storage path for image deletion.             |
| `shareCode`           | String (Optional) | 6-character shortcode for session joining.   |
| `shareCodeCreatedAt`  | Timestamp (Optional) | When the share code was generated.        |
| `shareCodeExpiresAt`  | Timestamp (Optional) | When the share code expires.              |
| `shareCodeCreatedBy`  | String (Optional) | UID of user who generated the share code.    |

## Balance Lifecycle

### On Review Step Entry

When the user enters the Review step (step 4), a `useEffect` in `BillWizard.tsx` automatically fires `applyBillBalances()` in the background:

1. Cross-references the bill's `people` IDs against the owner's friends list to resolve Firebase UIDs.
2. Computes the **delta** between current totals and `processedBalances` (previously committed amounts).
3. Runs one Firestore transaction per linked friend to update **[[friend_balances]]**.
4. Writes the updated totals back to `processedBalances` on the bill.
5. Automatically triggers UI updates because `getHydratedFriends` uses `onSnapshot` to re-fetch live balances.

> [!IMPORTANT]
> The trigger is **Review step entry**, not the "Done" button. This covers scenarios where the user:
> - Taps "Charge on Venmo" and leaves the app
> - Navigates away via back button after reviewing
> - Closes the browser tab from the Review screen
>
> `applyBillBalances` is **idempotent** — pressing Done after already viewing the review costs zero extra Firestore writes (delta = 0).

### On Bill Deletion

`reverseBillBalances()` is called **before** `deleteDoc()` in both `clearSession` and `deleteSession`:

1. Reads `processedBalances` from the bill.
2. For each friend in that map, runs a Firestore transaction to apply the **inverse** amount to **[[friend_balances]]**.
3. Automatically triggers UI updates because `getHydratedFriends` uses `onSnapshot` to re-fetch live balances.

> [!NOTE]
> If the bill was never reviewed (`processedBalances` absent or empty), `reverseBillBalances` returns immediately — nothing to undo.

### Historical Ledger Sync (Self-Healing)

`syncOldBillsForUser(userId)` is an automated background job that runs once every 24 hours when a user logs in. It fixes the ledger for legacy bills created before `friend_balances` existed:

1. Scans the user's past bills for any that lack `processedBalances`.
2. If the old bill has items and assignments, it calculates what the split *would have been*.
3. Runs `applyBillBalances` to seamlessly push the missing historical data into the new ledger.

## Concurrency

Updates to `itemAssignments` and `people` use Firestore's atomic `arrayUnion` / `arrayRemove` operations to prevent race conditions in collaborative sessions.

## Relationships

References **[Users](users.md)**, **[Events](events.md)**, **[Squads](squads.md)**, and **[[friend_balances]]**.
