---
title: Bills Collection Schema
date: 2026-02-21
tags: [database, schema, firestore, bills]
---

# `bills` Collection

The `bills` collection is the core transactional entity of the application. It represents a single receipt being split among multiple people. Documents are heavily updated in real-time during collaborative sessions.

## Document ID
Auto-generated by Firestore.

## Schema (`Bill`)

| Field               | Type              | Description                                                                                                                                                                                                           |
| ------------------- | ----------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `id`                | String            | The document ID.                                                                                                                                                                                                      |
| `title`             | String (Optional) | Custom name for the bill.                                                                                                                                                                                             |
| `billType`          | String            | Enum: `'private'` \| `'event'`.                                                                                                                                                                                       |
| `status`            | String            | Enum: `'active'` \| `'archived'`.                                                                                                                                                                                     |
| `ownerId`           | String            | Ref to **[Users](users.md)** (Creator/Payer).                                                                                                                                                                         |
| `eventId`           | String (Optional) | Ref to **[Events](events.md)** (if `billType === 'event'`).                                                                                                                                                           |
| `squadId`           | String (Optional) | Ref to **[Squads](squads.md)** (if imported from a squad).                                                                                                                                                            |
| `processedBalances` | Object (Optional) | Map of `{ [Firebase UID]: amountOwedToOwner }`. Tracking footprint of what was explicitly added to the global `friend_balances` ledger. Used by the Idempotent Delta engine to perfectly reverse math on re-edits. |
| `eventBalancesApplied` | Object (Optional) | Map of `{ [Firebase UID]: amountOwedToOwner }`. Tracks the exact math that was committed to the local `event_balances` ledger. |
| `settledPersonIds`  | Array of String | Optional list of users who have already settled their portion of this specific bill and should be calculated as owing $0. |
| `createdAt`         | Timestamp         | Creation time.                                                                                                                                                                                                        |
| `updatedAt`         | Timestamp         | Last modification time.                                                                                                                                                                                               |
| `lastActivity`      | Timestamp         | Tracks latest interaction.                                                                                                                                                                                            |

### Financial Data (`billData`)

Stores the actual money values involved.

| Sub-Field        | Type              | Description                            |
| ---------------- | ----------------- | -------------------------------------- |
| `restaurantName` | String (Optional) | Parsed restaurant name from receipt.   |
| `subtotal`       | Number            | Sum of all item prices before tax/tip. |
| `tax`            | Number            | Tax amount in USD.                     |
| `tip`            | Number            | Tip amount in USD.                     |
| `total`          | Number            | Grand total in USD.                    |
| `items`          | Array of Object   | `{ id, name, price }` per line item.   |

### Participant Data

- **`members`**: Array of `BillMember` objects. Records who officially joined the session via share link.
  - `userId`, `name`, `email`, `joinedAt`, `isAnonymous`
- **`people`**: Array of local `Person` objects (`{ id, name, venmoId? }`). This is the working list used during session to track everyone involved — including manually-added people who may not have Firebase accounts.

> [!IMPORTANT]
> The `id` field on a `Person` in the `people` array uses one of three formats:
> - **`user-{uid}`** — The standard format for any user added via the app (logged-in user, event members, friends list). Generated by `generateUserId(uid)`. The ledger services strip the `user-` prefix to recover the raw Firebase UID for balance writes.
> - **`guest-{uuid}`** — A guest user who joined via share link without logging in.
> - **`{random-uuid}`** — A person added purely by name in the bill wizard (no Firebase account). These are skipped by the balance engine since no Firebase UID can be resolved.
>
> Only `user-{uid}` people whose raw Firebase UID matches someone in the owner's `friends` list are written to **[[friend_balances]]** when the bill is finalized.

### Assignment Data

- **`itemAssignments`**: A Map where the key is `itemId` and the value is an array of `personId`s sharing that item.  
  *Example:* `{ "item_abc": ["uid_alice", "uid_bob"] }`
- **`splitEvenly`**: Boolean. If `true`, `itemAssignments` is overridden so every `personId` is on every item.

### Creation Lifecycle (Lazy Drafts)

To prevent database bloat, new bills utilize a **Client-Side Draft (Just-In-Time) Creation** flow rather than eager creation.

1.  **`/bill/new` Memory State**: When a user clicks "New Bill", the router navigates to `/bill/new`. At this stage, **no document exists in Firestore**. The `AIScanView` and `useBillSession` hook initialize empty temporary state in local React memory.
2.  **Smart Saving (JIT Creation)**: The `useBillSession` hook monitors the draft data. It refuses to call `billService.createBill` until the user performs a meaningful action (adding an item, taking a photo, or typing a title).
3.  **Step-Change/Unmount Saves**: Background saves do *not* fire on every keystroke to protect Firebase quotas. They exclusively fire when a user clicks 'Next' between wizard steps or actively navigates away from the page (unmounting).
4.  **Silent URL Swap**: Once meaningul data is entered and a save is triggered (e.g., clicking 'Next' after editing the title), the document is created yielding a Firestore ID. The client silently swamps the URL to `/bill/{new_id}` without refreshing the page, seamlessly transitioning from memory to realtime syncing.

### Session & Sharing

| Field                 | Type              | Description                                  |
| --------------------- | ----------------- | -------------------------------------------- |
| `currentStep`         | Number (Optional) | Tracks wizard step for draft resumption.     |
| `receiptImageUrl`     | String (Optional) | Firebase Storage download URL.               |
| `receiptFileName`     | String (Optional) | Storage path for image deletion.             |
| `shareCode`           | String (Optional) | 6-character shortcode for session joining.   |
| `shareCodeCreatedAt`  | Timestamp (Optional) | When the share code was generated.        |
| `shareCodeExpiresAt`  | Timestamp (Optional) | When the share code expires.              |
| `shareCodeCreatedBy`  | String (Optional) | UID of user who generated the share code.    |

## Balance Lifecycle

### On Review Step Entry

When the user enters the Review step (step 4), a `useEffect` in `BillWizard.tsx` automatically fires `applyBillBalancesIdempotent()` in the background:

1. Cross-references the bill's `people` IDs against the owner's friends list to resolve Firebase UIDs. Person IDs in the `user-{uid}` format have the prefix stripped to recover the raw Firebase UID before the comparison.
2. The Idempotent Delta engine reads `processedBalances`, strictly reverses that exact math from the ledger, then applies the new totals.
3. Runs one ACID Firestore transaction per linked friend to update **[[friend_balances]]**.
4. Writes the updated totals back to `processedBalances` on the bill.
5. Automatically triggers UI updates because `getHydratedFriends` uses `onSnapshot` to re-fetch live balances.

> [!NOTE]
> The `useEffect` dependency array includes `targetEventId` in addition to `wizard.currentStep`. This ensures the event ledger update fires correctly for **JIT-created event bills**, where `activeSession` (and therefore `eventId`) may not be populated until after the bill is first saved to Firestore. When `activeSession?.eventId` resolves, the effect re-runs and applies the event ledger update.

> [!IMPORTANT]
> The trigger is **Review step entry**, not the "Done" button. This covers scenarios where the user:
> - Taps "Charge on Venmo" and leaves the app
> - Navigates away via back button after reviewing
> - Closes the browser tab from the Review screen
>
> `applyBillBalancesIdempotent` is **idempotent** — pressing Done after already viewing the review executes the same math, yielding the exact same ledger numbers without double-spending.

### On Bill Deletion

`reverseBillBalancesIdempotent()` is called **before** `deleteDoc()` in both `clearSession` and `deleteSession`:

1. Reads `processedBalances` and `eventBalancesApplied` from the bill BEFORE triggering Firestore deletion.
2. Passes those explicit footprints into the Delta Engine as `providedPreviousBalances`. This prevents a race condition where the Delta Engine spins up after the bill is already deleted.
3. For each footprint, the Delta Engine subtracts that specific footprint from **[[friend_balances]]** and `event_balances`.
4. Automatically triggers UI updates because `getHydratedFriends` and Event ledgers use `onSnapshot` to re-fetch live balances.

> [!NOTE]
> If the bill was never reviewed (`processedBalances` absent or empty), `reverseBillBalancesIdempotent` returns immediately — nothing to undo.

### Historical Ledger Sync (Self-Healing)

`syncOldBillsForUser(userId)` is an automated background job that runs once every 24 hours when a user logs in. It fixes the ledger for legacy bills created before `friend_balances` existed:

1. Scans the user's past bills for any that lack `processedBalances`.
2. If the old bill has items and assignments, it calculates what the split *would have been*.
3. Runs `applyBillBalances` to seamlessly push the missing historical data into the new ledger.

## Concurrency

Updates to `itemAssignments` and `people` use Firestore's atomic `arrayUnion` / `arrayRemove` operations to prevent race conditions in collaborative sessions.

## Relationships

References **[Users](users.md)**, **[Events](events.md)**, **[Squads](squads.md)**, and **[[friend_balances]]**.
